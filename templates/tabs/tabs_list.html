{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
<main class="main-container">
  <div class="content-grid">

    <!-- Sidebar -->
    <aside class="sidebar">

      <!-- Category Section -->
      <div class="category-section">
        <h3 class="section-heading">Show Categories</h3>
        <div class="category-links">
          <a href="{% url 'tabs:tabs_list' %}" class="category-link">
            <span class="category-text">Songs</span>
            <span class="category-count">{{ counts.songs }}</span>
          </a>
          <a href="{% url 'tabs:albums_list' %}" class="category-link">
            <span class="category-text">Albums</span>
            <span class="category-count">{{ counts.albums }}</span>
          </a>
          <a href="{% url 'tabs:artists_list' %}" class="category-link">
            <span class="category-text">Artists</span>
            <span class="category-count">{{ counts.artists }}</span>
          </a>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="filters-section">
        <h3 class="section-heading">Filters</h3>

        <!-- Name -->
        <div class="filter-group">
          <label class="filter-label">Name (A - Z)</label>
          <select id="sortSelect" class="filter-select">
            <option value="A to Z" {% if sort_by == "A to Z" %}selected{% endif %}>A to Z</option>
            <option value="Z to A" {% if sort_by == "Z to A" %}selected{% endif %}>Z to A</option>
            <option value="Recently Added" {% if sort_by == "Recently Added" %}selected{% endif %}>Recently Added</option>
            <option value="Most Popular" {% if sort_by == "Most Popular" %}selected{% endif %}>Most Popular</option>
          </select>
        </div>

        <!-- Tuning -->
        <div class="filter-group">
          <label class="filter-label">Tuning</label>
          <select id="tuningSelect" class="filter-select">
            <option value="All Tunings" {% if not tuning_filter or tuning_filter == "All Tunings" %}selected{% endif %}>All Tunings</option>
            <option value="E Standard" {% if tuning_filter == "E Standard" %}selected{% endif %}>E Standard</option>
            <option value="Drop D" {% if tuning_filter == "Drop D" %}selected{% endif %}>Drop D</option>
            <option value="Drop C" {% if tuning_filter == "Drop C" %}selected{% endif %}>Drop C</option>
            <option value="Drop B" {% if tuning_filter == "Drop B" %}selected{% endif %}>Drop B</option>
            <option value="DADGAD" {% if tuning_filter == "DADGAD" %}selected{% endif %}>DADGAD</option>
          </select>
        </div>

        <!-- Difficulty Slider -->
        <div class="filter-group">
          <label class="filter-label">Difficulty</label>
          <div class="difficulty-slider">
            <div class="slider-container">
              <div id="activeTrack" class="slider-active-track"></div>

              <!-- Range Inputs -->
              <input id="minRange" type="range" min="1" max="4" value="{{ min_difficulty|default:1 }}" step="1"
                     class="slider-input slider-min">
              <input id="maxRange" type="range" min="1" max="4" value="{{ max_difficulty|default:4 }}" step="1"
                     class="slider-input slider-max">

              <!-- Handles (no bubbles) -->
              <div id="minHandle" class="slider-handle">
                <div class="handle-dot"></div>
              </div>

              <div id="maxHandle" class="slider-handle">
                <div class="handle-dot"></div>
              </div>
            </div>

            <div class="slider-labels">
              <span>1</span>
              <span>2</span>
              <span>3</span>
              <span>4</span>
            </div>
          </div>
        </div>

      </div>
    </aside>

    <!-- Songs Section -->
    <section id="songContainer" class="songs-section">
      <div class="tabs-grid">
        {% for song in page_obj %}
          <div class="tab-card">
            <div class="tab-image">
              <img src="{{ song.album.album_img}}" alt="{{ song.artist.name }}" 
                   class="tab-img">
            </div>

            <div class="tab-content">
              <div class="tab-info">
                <h3 class="tab-title">
                  <a href="{% url 'tabs:song_detail' artist_slug=song.artist.name_cleaned album_slug=song.album.title_cleaned song_slug=song.title_cleaned %}" 
                     class="tab-link">
                    {{ song.title }}
                  </a>
                </h3>

                <p class="tab-artist">{{ song.artist.name }}</p>
                <p class="tab-album">
                  {% if song.album %}{{ song.album.title }}{% else %}No Album{% endif %}
                </p>
              </div>

              <div class="tab-meta">
                <span class="tab-year">{{ song.date_added|date:"Y" }}</span>
                <span class="tab-tuning">
                  {% if song.tuning %}{{ song.tuning }}{% else %}Standard{% endif %}
                </span>
              </div>
            </div>
          </div>
        {% empty %}
          <p class="no-songs">No songs found.</p>
        {% endfor %}
      </div>
    </section>

  </div>
</main>
{% endblock %}


{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const minRange = document.getElementById("minRange");
  const maxRange = document.getElementById("maxRange");
  const minHandle = document.getElementById("minHandle");
  const maxHandle = document.getElementById("maxHandle");
  const activeTrack = document.getElementById("activeTrack");
  const sortSelect = document.getElementById("sortSelect");
  const tuningSelect = document.getElementById("tuningSelect");
  const songContainer = document.getElementById("songContainer");
  const sliderContainer = document.querySelector('.slider-container');

  // Initialize with default values
  minRange.value = "{{ min_difficulty|default:1 }}";
  maxRange.value = "{{ max_difficulty|default:4 }}";

  function updateSlider() {
    let min = parseInt(minRange.value);
    let max = parseInt(maxRange.value);

    // Ensure min doesn't exceed max and vice versa
    if (min > max) {
      if (minRange === document.activeElement) {
        maxRange.value = min;
      } else {
        minRange.value = max;
      }
      min = parseInt(minRange.value);
      max = parseInt(maxRange.value);
    }

    const minPercent = ((min - 1) / 3) * 100;
    const maxPercent = ((max - 1) / 3) * 100;

    // Update visual elements
    activeTrack.style.left = `${minPercent}%`;
    activeTrack.style.width = `${maxPercent - minPercent}%`;
    minHandle.style.left = `${minPercent}%`;
    maxHandle.style.left = `${maxPercent}%`;

    // Z-index management for better handle interaction
    minRange.style.zIndex = min >= max - 1 ? 5 : 10;
    maxRange.style.zIndex = min >= max - 1 ? 10 : 5;
  }

  // Enhanced slider interaction
  function setupSliderInteraction() {
    let isDragging = false;
    let currentSlider = null;

    function handleSliderMove(e) {
      if (!isDragging) return;

      const rect = sliderContainer.getBoundingClientRect();
      const x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
      let percent = ((x - rect.left) / rect.width) * 100;
      percent = Math.max(0, Math.min(100, percent)); // Clamp between 0-100%

      const value = Math.round(1 + (percent / 100) * 3); // Convert to 1-4 scale

      if (currentSlider === minRange) {
        minRange.value = value;
      } else if (currentSlider === maxRange) {
        maxRange.value = value;
      }

      updateSlider();
    }

    function handleSliderEnd() {
      isDragging = false;
      currentSlider = null;
      document.removeEventListener('mousemove', handleSliderMove);
      document.removeEventListener('touchmove', handleSliderMove);
      document.removeEventListener('mouseup', handleSliderEnd);
      document.removeEventListener('touchend', handleSliderEnd);
      
      // Apply filters when dragging ends
      applyFilters();
    }

    // Handle events for both handles
    [minHandle, maxHandle].forEach((handle, index) => {
      const slider = index === 0 ? minRange : maxRange;

      // Mouse events
      handle.addEventListener('mousedown', (e) => {
        e.preventDefault();
        isDragging = true;
        currentSlider = slider;
        document.addEventListener('mousemove', handleSliderMove);
        document.addEventListener('mouseup', handleSliderEnd);
      });

      // Touch events for mobile
      handle.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDragging = true;
        currentSlider = slider;
        document.addEventListener('touchmove', handleSliderMove, { passive: false });
        document.addEventListener('touchend', handleSliderEnd);
      });

      // Click on track to move handles
      sliderContainer.addEventListener('click', (e) => {
        const rect = sliderContainer.getBoundingClientRect();
        const x = e.clientX;
        const percent = ((x - rect.left) / rect.width) * 100;
        const value = Math.round(1 + (percent / 100) * 3);

        // Determine which handle to move based on click position
        const minValue = parseInt(minRange.value);
        const maxValue = parseInt(maxRange.value);
        const minPos = ((minValue - 1) / 3) * 100;
        const maxPos = ((maxValue - 1) / 3) * 100;

        if (Math.abs(percent - minPos) < Math.abs(percent - maxPos)) {
          // Closer to min handle
          minRange.value = Math.min(value, maxValue);
        } else {
          // Closer to max handle
          maxRange.value = Math.max(value, minValue);
        }

        updateSlider();
        applyFilters();
      });
    });

    // Still allow direct range input interaction
    minRange.addEventListener('input', () => {
      updateSlider();
    });

    maxRange.addEventListener('input', () => {
      updateSlider();
    });

    // Apply filters when range inputs change (for keyboard users)
    minRange.addEventListener('change', applyFilters);
    maxRange.addEventListener('change', applyFilters);
  }

  async function applyFilters() {
    const params = new URLSearchParams({
      sort: sortSelect.value,
      tuning: tuningSelect.value,
      min_difficulty: minRange.value,
      max_difficulty: maxRange.value,
    });

    try {
      const response = await fetch(`?${params.toString()}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const html = await response.text();
      const parser = new DOMParser();
      const newDoc = parser.parseFromString(html, "text/html");
      const newSongs = newDoc.querySelector("#songContainer");
      
      if (newSongs) {
        songContainer.innerHTML = newSongs.innerHTML;
        
        // Update URL without page reload
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.pushState({}, '', newUrl);
      }
    } catch (error) {
      console.error("Filter error:", error);
    }
  }

  // Add some CSS for better handle interaction
  const style = document.createElement('style');
  style.textContent = `
    .slider-handle {
      cursor: grab;
      transition: left 0.1s ease;
    }
    .slider-handle:active {
      cursor: grabbing;
    }
    .handle-dot {
      transition: transform 0.1s ease;
    }
    .slider-handle:hover .handle-dot {
      transform: scale(1.2);
    }
    .slider-container {
      cursor: pointer;
    }
  `;
  document.head.appendChild(style);

  // Initialize everything
  updateSlider();
  setupSliderInteraction();

  // Other filter events
  sortSelect.addEventListener("change", applyFilters);
  tuningSelect.addEventListener("change", applyFilters);

  // Handle browser back/forward buttons
  window.addEventListener('popstate', function() {
    const urlParams = new URLSearchParams(window.location.search);
    minRange.value = urlParams.get('min_difficulty') || 1;
    maxRange.value = urlParams.get('max_difficulty') || 4;
    sortSelect.value = urlParams.get('sort') || 'A to Z';
    tuningSelect.value = urlParams.get('tuning') || 'All Tunings';
    
    updateSlider();
    applyFilters();
  });
});
</script>
{% endblock %}
