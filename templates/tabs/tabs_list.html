{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
{% endblock %}

{% block content %}
<main class="container mx-auto px-5 flex-1 py-10">
  <div class="grid grid-cols-1 lg:grid-cols-[300px,1fr] gap-10">

    <!-- Sidebar -->
    <aside class="flex flex-col gap-8">

      <!-- Category Section -->
      <div class="bg-primary/15 border border-primary/30 rounded-xl p-6">
        <h3 class="text-xl font-semibold text-white mb-5">Show Categories</h3>
        <div class="flex flex-col gap-3">
          <a href="{% url 'tabs:tabs_list' %}" 
             class="flex justify-between items-center p-3 bg-white/5 border border-white/10 rounded-lg hover:bg-primary/20 hover:border-primary">
            <span class="text-white font-medium">Songs</span>
            <span class="bg-white/20 py-1 px-2 rounded-xl text-sm text-gray-300">{{ counts.songs }}</span>
          </a>
          <a href="{% url 'tabs:albums_list' %}" 
             class="flex justify-between items-center p-3 bg-white/5 border border-white/10 rounded-lg hover:bg-primary/20 hover:border-primary">
            <span class="text-white font-medium">Albums</span>
            <span class="bg-white/20 py-1 px-2 rounded-xl text-sm text-gray-300">{{ counts.albums }}</span>
          </a>
          <a href="{% url 'tabs:artists_list' %}" 
             class="flex justify-between items-center p-3 bg-white/5 border border-white/10 rounded-lg hover:bg-primary/20 hover:border-primary">
            <span class="text-white font-medium">Artists</span>
            <span class="bg-white/20 py-1 px-2 rounded-xl text-sm text-gray-300">{{ counts.artists }}</span>
          </a>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="bg-primary/15 border border-primary/30 rounded-xl p-6">
        <h3 class="text-xl font-semibold text-white mb-5">Filters</h3>

        <!-- Name -->
        <div class="mb-6">
          <label class="block text-white font-medium mb-2.5">Name (A - Z)</label>
          <select id="sortSelect" 
                  class="w-full py-3 px-4 bg-white/10 border border-white/20 rounded-lg text-white outline-none text-base">
            <option value="A to Z" {% if sort_by == "A to Z" %}selected{% endif %}>A to Z</option>
            <option value="Z to A" {% if sort_by == "Z to A" %}selected{% endif %}>Z to A</option>
            <option value="Recently Added" {% if sort_by == "Recently Added" %}selected{% endif %}>Recently Added</option>
            <option value="Most Popular" {% if sort_by == "Most Popular" %}selected{% endif %}>Most Popular</option>
          </select>
        </div>

        <!-- Tuning -->
        <div class="mb-6">
          <label class="block text-white font-medium mb-2.5">Tuning</label>
          <select id="tuningSelect" 
                  class="w-full py-3 px-4 bg-white/10 border border-white/20 rounded-lg text-white outline-none text-base">
            <option value="All Tunings" {% if not tuning_filter or tuning_filter == "All Tunings" %}selected{% endif %}>All Tunings</option>
            <option value="E Standard" {% if tuning_filter == "E Standard" %}selected{% endif %}>E Standard</option>
            <option value="Drop D" {% if tuning_filter == "Drop D" %}selected{% endif %}>Drop D</option>
            <option value="Drop C" {% if tuning_filter == "Drop C" %}selected{% endif %}>Drop C</option>
            <option value="Drop B" {% if tuning_filter == "Drop B" %}selected{% endif %}>Drop B</option>
            <option value="DADGAD" {% if tuning_filter == "DADGAD" %}selected{% endif %}>DADGAD</option>
          </select>
        </div>

        <!-- Difficulty Slider -->
        <div class="mb-6">
          <label class="block text-white font-medium mb-2.5">Difficulty</label>
          <div class="difficulty-slider mt-8 relative w-full select-none">
            <div class="slider-container relative h-2 bg-gray-700 rounded-full">
              <div id="activeTrack" 
                   class="absolute top-0 h-2 bg-primary rounded-full transition-all duration-150"></div>

              <!-- Range Inputs -->
              <input id="minRange" type="range" min="1" max="4" value="{{ min_difficulty|default:1 }}" step="1"
                     class="absolute w-full h-2 opacity-0 cursor-pointer z-30 top-0 left-0">
              <input id="maxRange" type="range" min="1" max="4" value="{{ max_difficulty|default:4 }}" step="1"
                     class="absolute w-full h-2 opacity-0 cursor-pointer z-20 top-0 left-0">

              <!-- Handles (no bubbles) -->
              <div id="minHandle" class="absolute top-1/2 -translate-y-1/2 pointer-events-none z-40">
                <div class="handle-dot w-5 h-5 bg-primary rounded-full border-2 border-white shadow-md"></div>
              </div>

              <div id="maxHandle" class="absolute top-1/2 -translate-y-1/2 pointer-events-none z-40">
                <div class="handle-dot w-5 h-5 bg-primary rounded-full border-2 border-white shadow-md"></div>
              </div>
            </div>

            <div class="flex justify-between text-gray-400 text-xs mt-4 px-1">
              <span>1</span>
              <span>2</span>
              <span>3</span>
              <span>4</span>
            </div>
          </div>
        </div>

      </div>
    </aside>

    <!-- Songs Section -->
    <section id="songContainer" class="tab-section">
      <div class="tabs-container grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
        {% for song in page_obj %}
          <div class="tab-card bg-zinc-900 border border-zinc-800 rounded-xl overflow-hidden 
                      hover:-translate-y-2 hover:shadow-2xl hover:border-primary transition-all duration-300 
                      cursor-pointer flex flex-col">
            <div class="relative w-full h-56 overflow-hidden">
              <img src="{{ song.artist.artist_img }}" alt="{{ song.artist.name }}" 
                   class="w-full h-full object-cover">
            </div>

            <div class="p-4 flex flex-col justify-between flex-grow">
              <div>
                <h3 class="text-lg font-semibold text-white mb-1">
                  <a href="{% url 'tabs:song_detail' artist_slug=song.artist.name_cleaned album_slug=song.album.title_cleaned song_slug=song.title_cleaned %}" 
                     class="hover:text-primary transition">
                    {{ song.title }}
                  </a>
                </h3>

                <p class="text-sm text-gray-300">{{ song.artist.name }}</p>
                <p class="text-sm text-gray-400 italic">
                  {% if song.album %}{{ song.album.title }}{% else %}No Album{% endif %}
                </p>
              </div>

              <div class="flex justify-between items-center mt-auto border-zinc-800">
                <span class="text-xs text-gray-500">{{ song.date_added|date:"Y" }}</span>
                <span class="bg-zinc-800 border border-zinc-700 rounded-md text-white py-1 px-3 text-xs font-medium 
                             hover:bg-zinc-700 transition">
                  {% if song.tuning %}{{ song.tuning }}{% else %}Standard{% endif %}
                </span>
              </div>
            </div>
          </div>
        {% empty %}
          <p class="text-white">No songs found.</p>
        {% endfor %}
      </div>
    </section>

  </div>
</main>
{% endblock %}


{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const minRange = document.getElementById("minRange");
  const maxRange = document.getElementById("maxRange");
  const minHandle = document.getElementById("minHandle");
  const maxHandle = document.getElementById("maxHandle");
  const activeTrack = document.getElementById("activeTrack");
  const sortSelect = document.getElementById("sortSelect");
  const tuningSelect = document.getElementById("tuningSelect");
  const songContainer = document.getElementById("songContainer");

  // Initialize with default values
  minRange.value = "{{ min_difficulty|default:1 }}";
  maxRange.value = "{{ max_difficulty|default:4 }}";

  function updateSlider() {
    let min = parseInt(minRange.value);
    let max = parseInt(maxRange.value);

    // Ensure min â‰¤ max
    if (min > max) {
      [min, max] = [max, min];
      minRange.value = min;
      maxRange.value = max;
    }

    const minPercent = ((min - 1) / 3) * 100;
    const maxPercent = ((max - 1) / 3) * 100;

    activeTrack.style.left = `${minPercent}%`;
    activeTrack.style.width = `${maxPercent - minPercent}%`;
    minHandle.style.left = `${minPercent}%`;
    maxHandle.style.left = `${maxPercent}%`;

    if (min >= max - 1) {
      minRange.style.zIndex = 5;
      maxRange.style.zIndex = 10;
    } else {
      minRange.style.zIndex = 10;
      maxRange.style.zIndex = 5;
    }
  }

  async function applyFilters() {
    const params = new URLSearchParams({
      sort: sortSelect.value,
      tuning: tuningSelect.value,
      min_difficulty: minRange.value,
      max_difficulty: maxRange.value,
    });

    try {
      const response = await fetch(`?${params.toString()}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      const html = await response.text();
      const parser = new DOMParser();
      const newDoc = parser.parseFromString(html, "text/html");
      const newSongs = newDoc.querySelector("#songContainer");
      if (newSongs) songContainer.innerHTML = newSongs.innerHTML;
    } catch (error) {
      console.error("Filter error:", error);
    }
  }

  // Initialize
  updateSlider();

  // Update events
  minRange.addEventListener("input", updateSlider);
  maxRange.addEventListener("input", updateSlider);
  minRange.addEventListener("change", applyFilters);
  maxRange.addEventListener("change", applyFilters);
  sortSelect.addEventListener("change", applyFilters);
  tuningSelect.addEventListener("change", applyFilters);
});
</script>
{% endblock %}
